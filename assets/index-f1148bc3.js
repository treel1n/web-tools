var H=Object.defineProperty;var R=(c,e,o)=>e in c?H(c,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):c[e]=o;var g=(c,e,o)=>(R(c,typeof e!="symbol"?e+"":e,o),o);import{r as h,j as t,d as u}from"./index-bfc6f212.js";const T="_lottery-config-warpper_12ep6_1",N="_lottery-config-operate_12ep6_4",V="_lottery-board_12ep6_12",W="_lottery-overflow_12ep6_17",x={"lottery-config-warpper":"_lottery-config-warpper_12ep6_1",lotteryConfigWarpper:T,"lottery-config-operate":"_lottery-config-operate_12ep6_4",lotteryConfigOperate:N,"lottery-board":"_lottery-board_12ep6_12",lotteryBoard:V,"lottery-overflow":"_lottery-overflow_12ep6_17",lotteryOverflow:W},_=(c,e)=>{const o=new ReferenceError("IndexDB write error:",c);e(o)};class M{constructor(){g(this,"_name","toolsDB");g(this,"_version",2);g(this,"DB",window.indexedDB);g(this,"db");g(this,"dbLinkFn");const e=this.DB.open(this._name,this._version);let o,i;this.dbLinkFn=new Promise((s,n)=>(o=s,i=n)),e.onsuccess=()=>{console.log("Success creating/accessing IndexedDB database"),this.db=e.result,o(!0)},e.onerror=()=>{const s=new ReferenceError("Error creating/accessing IndexedDB database");console.error(s),i(s)},e.onupgradeneeded=s=>{if(console.log(111),this.db=s.target.result,!this.db.objectStoreNames.contains("Code")){const n=this.db.createObjectStore("Code",{keyPath:"id",autoIncrement:!0});n.createIndex("id","id",{unique:!0}),n.createIndex("mobile","mobile",{unique:!1})}if(!this.db.objectStoreNames.contains("Lottery")){const n=this.db.createObjectStore("Lottery",{keyPath:"id",autoIncrement:!0});n.createIndex("id","id",{unique:!0}),n.createIndex("memo","memo",{unique:!0}),n.createIndex("options","options",{unique:!1})}}}async addData(e,o){await this.dbLinkFn;let i,s;const n=new Promise((a,d)=>(i=a,s=d)),l=this.db.transaction(e,"readwrite").objectStore(e).add(o);return l.onsuccess=()=>i(!0),l.onerror=a=>{const d=new ReferenceError("IndexDB write error:",a);s(d)},n}async getData(e){await this.dbLinkFn;let o,i;const s=new Promise((d,f)=>(o=d,i=f));let n=[];const a=this.db.transaction(e,"readwrite").objectStore(e).openCursor();return a.onerror=d=>_(d,i),a.onsuccess=d=>{var f=d.target.result;f?(n.push(f.value),f.continue()):o(n)},s}async deleteData(e,o){await this.dbLinkFn;let i,s;const n=new Promise((a,d)=>(i=a,s=d)),l=this.db.transaction(e,"readwrite").objectStore(e).delete(o);return l.onerror=a=>_(a,s),l.onsuccess=()=>i(!0),n}async updateData(e,o){await this.dbLinkFn;let i,s;const n=new Promise((a,d)=>(i=a,s=d)),l=this.db.transaction([e],"readwrite").objectStore(e).put(o);return l.onsuccess=()=>i(!0),l.onerror=a=>_(a,s),n}}const B=new M,J=()=>{const[c,e]=h.useState(""),[o,i]=h.useState(""),[s,n]=h.useState("Ready"),[l,a]=h.useState([]),[d,f]=h.useState(!1),[L,v]=h.useState(!1),[O,j]=h.useState(!1),[w,C]=h.useState(!1),[P,A]=h.useState(),[D,k]=h.useState();h.useMemo(async()=>{const r=await B.getData("Lottery");a(r),r.length&&I(r[0].id,r)},[]);const S=()=>o.trim().split(`
`).map(p=>p.trim()).filter(p=>!!p),q=()=>{if(w)return;const r=S(),p=r.length;if(!p)return j(!0);C(!0);const m=setInterval(()=>{const y=~~(Math.random()*p);n(r[y])},20);k(m)},F=()=>{clearInterval(D),k(void 0);const r=S(),p=r.length;for(let m=1;m<=10;m++)(function(y){setTimeout(()=>{const b=~~(Math.random()*p);n(r[b]),y===10&&(f(!0),C(!1))},y*y*15)})(m)},E=async()=>{if(!c)return v(!0);const r=S();if(!r.length)return j(!0);const p=l.find(y=>y.memo===c);if(p){const y={memo:c,options:r,id:p.id};await B.updateData("Lottery",y),a(l.map(b=>b.id!==p.id?b:y));return}const m={memo:c,options:r};await B.addData("Lottery",{memo:c,options:r}),a(l.concat({id:Date.now(),...m}))},I=(r,p=l)=>{const m=p.find(y=>y.id===r);i(m.options.join(`
`)),A(r)};return t.jsxs(u.NavPageContainer,{animateTransition:!0,hasPadding:!0,children:[t.jsx("h1",{children:"Lottery"}),t.jsx("p",{children:"抽奖小工具"}),t.jsx("div",{className:"app-hr"}),t.jsxs("div",{className:x.lotteryConfigWarpper,children:[t.jsx(u.TextArea,{value:o,style:{minWidth:"520px",minHeight:"200px"},onChange:r=>i(r.target.value),placeholder:`一等奖
二等奖
三等奖`}),t.jsxs("div",{className:x.lotteryConfigOperate,children:[t.jsx(u.Button,{type:"primary",onClick:w?F:q,value:w?"Stop":"Start",isLoading:w&&!D}),t.jsx(u.InputText,{value:c,onChange:r=>e(r.target.value),placeholder:"保存的备注名称一致则替换"}),t.jsx(u.Button,{style:{marginTop:10},type:"primary",onClick:E,value:"Save to history"}),l.length?t.jsxs(t.Fragment,{children:[t.jsx("h5",{children:"Select from history"}),t.jsx(u.Select,{defaultValue:P,onChange:I,data:l.map(r=>({label:r.memo,value:r.id}))})]}):null]})]}),t.jsx("div",{className:"app-section-container-fg app-mt-20",children:t.jsx("div",{className:[x.lotteryBoard,x.lotteryOverflow].join(" "),children:s})}),t.jsx(u.Dialog,{isVisible:d,onBackdropPress:()=>f(!1),children:t.jsxs(u.Dialog.Body,{style:{padding:15},children:[t.jsx("h2",{className:"app-m-0",children:"Congratulate"}),t.jsx("p",{className:x.lotteryOverflow,children:s}),t.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:t.jsx(u.Button,{value:"Ok",type:"primary",onClick:()=>f(!1)})})]})}),t.jsx(u.Alert,{isVisible:L,onBackdropPress:()=>v(!1),title:"Alert",message:"请输入备注",children:t.jsx(u.Alert.Footer,{children:t.jsx(u.Button,{type:"primary",value:"Ok",onClick:()=>v(!1)})})}),t.jsx(u.Alert,{isVisible:O,onBackdropPress:()=>j(!1),title:"Alert",message:"请输入抽奖内容",children:t.jsx(u.Alert.Footer,{children:t.jsx(u.Button,{type:"primary",value:"Ok",onClick:()=>j(!1)})})})]})};export{J as default};
